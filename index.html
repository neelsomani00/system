<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Matrix - Solo Leveling Progression</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'sys-black': 'var(--sys-black)',
                        'sys-blue': 'var(--sys-blue)',
                        'sys-purple': 'var(--sys-purple)',
                        'sys-neon': 'var(--sys-neon)',
                        'sys-card': 'var(--sys-card-bg)',
                        'sys-bg': 'var(--sys-bg)',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Default Dark Theme: Sung Jin Woo System */
        :root {
            --sys-black: #0d1117;
            --sys-blue: #1c2b41;
            --sys-purple: #8e2de2;
            --sys-neon: #4a00e0;
            --sys-card-bg: rgba(28, 43, 65, 0.4); /* Dark blue transparency */
            --sys-bg: #0d1117;
            --sys-text: #e2e8f0;
            --sys-glow-filter: drop-shadow(0 0 5px var(--sys-purple)) drop-shadow(0 0 10px var(--sys-neon));
            --sys-focus-glow: #10b981; /* Neon Green */
            --sys-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }

        /* Light Theme: Google Standard */
        .light-mode {
            --sys-black: #f1f3f4;
            --sys-blue: #ffffff;
            --sys-purple: #1a73e8;
            --sys-neon: #4285f4;
            --sys-card-bg: rgba(255, 255, 255, 0.9);
            --sys-bg: #f1f3f4;
            --sys-text: #202124;
            --sys-glow-filter: none;
            --sys-focus-glow: #f9d71c; /* Google Yellow */
            --sys-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            background-color: var(--sys-bg);
            color: var(--sys-text);
            transition: background-color 0.5s, color 0.5s;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: 'Inter', sans-serif;
            /* FIX: Ensure no horizontal scrolling on smaller devices */
            overflow-x: hidden; 
        }

        .sys-container {
            flex-grow: 1;
        }

        .sys-card {
            background: var(--sys-card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--sys-shadow);
            transition: all 0.3s ease-in-out;
            will-change: transform, box-shadow;
        }

        .sys-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(74, 0, 224, 0.4);
            filter: var(--sys-glow-filter);
        }

        .sys-button {
            background: linear-gradient(90deg, var(--sys-purple), var(--sys-neon));
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(142, 45, 226, 0.5);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
            overflow: hidden;
            position: relative;
        }

        .sys-button:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 6px 20px rgba(142, 45, 226, 0.7);
        }
        
        .sys-button:active {
            transform: scale(0.98);
        }

        /* Neon Glow Effect for Selected Stat */
        .stat-card.focused {
            border: 3px solid var(--sys-focus-glow);
            box-shadow: 0 0 20px var(--sys-focus-glow), 0 0 5px var(--sys-focus-glow);
            transform: scale(1.03);
        }

        /* Responsive Hamburger Menu Styling */
        .mobile-nav {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }

        .mobile-nav.open {
            transform: translateX(0);
        }

        /* Progression Bar Animation */
        .xp-bar {
            height: 100%;
            background: linear-gradient(90deg, #3f0071, var(--sys-purple));
            transition: width 0.5s ease-out;
            border-radius: 9999px;
            filter: var(--sys-glow-filter);
        }

        /* Calendar Styling */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }
        .day-cell {
            padding: 0.5rem;
            text-align: center;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .day-cell:hover {
            background-color: var(--sys-blue);
        }
        .leave-day {
            background-color: rgba(220, 38, 38, 0.7) !important; /* Red for leave */
            filter: drop-shadow(0 0 5px #dc2626);
        }
        .exam-day {
            background-color: rgba(59, 130, 246, 0.7) !important; /* Blue for exam */
            filter: drop-shadow(0 0 5px #3b82f6);
        }
        
        /* Activation Screen Styles */
        .activation-card {
            background: var(--sys-card-bg);
            backdrop-filter: blur(20px);
            border: 2px solid var(--sys-neon);
            box-shadow: 0 0 40px var(--sys-neon);
            animation: pulse 2s infinite alternate;
        }

        @keyframes pulse {
            from { box-shadow: 0 0 20px var(--sys-neon), 0 0 5px var(--sys-purple); }
            to { box-shadow: 0 0 40px var(--sys-neon), 0 0 10px var(--sys-purple); }
        }

        /* Google button style for visual flair */
        .google-button {
            background-color: #4285f4;
            color: white;
            transition: background-color 0.3s;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.5);
        }

        .google-button:hover {
            background-color: #357ae8;
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.7);
        }
        
    </style>
</head>
<body class="dark-mode">

    <section id="start-screen" class="fixed inset-0 z-[100] flex items-center justify-center p-4 transition-opacity duration-700 ease-in-out bg-sys-black/90">
        <div class="activation-card max-w-lg w-full p-8 md:p-12 rounded-2xl text-center">
            <i class="ph-fill ph-circles-three-plus text-7xl mb-4 text-sys-neon filter-sys-glow-filter"></i>
            <h1 class="text-4xl font-extrabold text-white mb-2">SYSTEM ACTIVATION REQUIRED</h1>
            <p class="text-lg text-sys-text opacity-80 mb-6">Please choose your method of authentication to initialize the progression matrix.</p>
            
            <div class="space-y-4">
                <button id="google-sign-in-button" class="google-button w-full text-xl py-4 rounded-full font-bold flex items-center justify-center">
                    <i class="ph-fill ph-google-logo text-xl mr-3"></i> SIGN IN WITH GOOGLE
                </button>
                
                <div class="flex items-center justify-center space-x-2 text-sm opacity-60">
                    <hr class="flex-grow border-sys-card">
                    <span class="text-sys-text">OR</span>
                    <hr class="flex-grow border-sys-card">
                </div>

                <form id="name-form" class="space-y-4">
                    <input type="text" id="player-name-input" placeholder="Enter Your Name Manually" value="NEEL" required
                        class="w-full p-4 text-xl rounded-lg bg-sys-blue/70 border-2 border-sys-neon/50 text-sys-text placeholder-gray-500 focus:border-sys-focus-glow outline-none transition">
                    <button type="submit" class="sys-button w-full text-xl py-4">
                        <i class="ph ph-lightning-fill text-xl mr-2"></i> ACTIVATE SYSTEM (Manual)
                    </button>
                </form>
            </div>
            <p class="text-xs mt-6 opacity-50">Activation Sequence 1.0.4 | Initializing Core Progression Modules...</p>
        </div>
    </section>

    <div id="app-container" class="opacity-0 transition-opacity duration-500 flex flex-col min-h-screen">
        
        <header class="sticky top-0 z-50 p-4 bg-sys-black border-b border-sys-card shadow-lg">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sys-purple to-sys-neon">
                    SYSTEM MATRIX
                </h1>
                
                <nav class="hidden md:flex space-x-6 text-sm font-medium">
                    <a href="#" onclick="navigateTo('index')" class="text-sys-text hover:text-sys-neon transition duration-200">DASHBOARD</a>
                    <a href="#" onclick="navigateTo('quests')" class="text-sys-text hover:text-sys-neon transition duration-200">MISSIONS</a>
                    <a href="#" onclick="navigateTo('stats')" class="text-sys-text hover:text-sys-neon transition duration-200">PROGRESSION</a>
                    <a href="#" onclick="navigateTo('cms')" class="text-sys-text hover:text-sys-neon transition duration-200">SYSTEM EDITOR</a>
                </nav>

                <div class="flex items-center space-x-4">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-sys-card transition duration-200" aria-label="Toggle Theme">
                        <i id="theme-icon" class="ph-fill ph-sun text-xl text-sys-text"></i>
                    </button>
                    <button id="sign-out-button" onclick="signOutUser()" class="p-2 rounded-full hover:bg-red-500/20 transition duration-200" aria-label="Sign Out">
                        <i class="ph-bold ph-sign-out text-xl text-red-400"></i>
                    </button>
                    
                    <button id="menu-button" class="md:hidden p-2 rounded-full hover:bg-sys-card transition duration-200" aria-label="Open Menu">
                        <i class="ph-bold ph-list text-2xl text-sys-text"></i>
                    </button>
                </div>
            </div>
        </header>

        <nav id="mobile-menu" class="mobile-nav fixed top-0 right-0 w-64 h-full bg-sys-black p-6 z-[60] md:hidden">
            <div class="flex justify-end">
                <button onclick="toggleMenu()" class="text-sys-text p-2"><i class="ph-bold ph-x text-2xl"></i></button>
            </div>
            <div class="flex flex-col space-y-4 mt-8 text-lg font-medium">
                <a href="#" onclick="navigateTo('index'); toggleMenu();" class="text-sys-text hover:text-sys-neon transition duration-200 border-b border-sys-card pb-2">DASHBOARD</a>
                <a href="#" onclick="navigateTo('quests'); toggleMenu();" class="text-sys-text hover:text-sys-neon transition duration-200 border-b border-sys-card pb-2">MISSIONS</a>
                <a href="#" onclick="navigateTo('stats'); toggleMenu();" class="text-sys-text hover:text-sys-neon transition duration-200 border-b border-sys-card pb-2">PROGRESSION</a>
                <a href="#" onclick="navigateTo('cms'); toggleMenu();" class="text-sys-text hover:text-sys-neon transition duration-200 border-b border-sys-card pb-2">SYSTEM EDITOR</a>
                <button onclick="signOutUser(); toggleMenu();" class="text-left text-red-400 hover:text-red-300 transition duration-200 border-b border-sys-card pb-2">SIGN OUT</button>
            </div>
        </nav>


        <main class="sys-container p-4 md:p-8 max-w-7xl mx-auto w-full">
            <section id="index" class="view-section hidden">
                <h2 class="text-4xl font-bold mb-8 text-sys-text filter-sys-glow-filter">DASHBOARD_V2.1</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="sys-card p-6 rounded-xl col-span-1 h-fit">
                        <div class="flex items-center space-x-4 mb-4">
                            <i class="ph-fill ph-user-circle text-6xl text-sys-neon"></i>
                            <div>
                                <p class="text-sm uppercase opacity-75">Player ID: <span id="player-id">SJW-001</span></p>
                                <h3 class="text-2xl font-extrabold text-sys-text" id="player-name">NEEL</h3>
                            </div>
                        </div>
                        <p class="text-lg mb-4 text-sys-text">Title: <span class="font-bold text-sys-neon" id="player-title">Shadow Monarch</span></p>
                        
                        <div class="mb-4">
                            <p class="text-lg font-bold mb-1">Level <span id="player-level">1</span></p>
                            <div class="h-3 bg-sys-blue rounded-full overflow-hidden">
                                <div class="xp-bar" id="xp-bar" style="width: 50%;"></div>
                            </div>
                            <p class="text-xs mt-1 opacity-75 text-right"><span id="player-xp">50</span> / <span id="player-xp-cap">100</span> XP</p>
                        </div>

                        <p class="text-sm opacity-90 border-t border-sys-card pt-4">AI Focus: <span class="font-semibold text-sys-focus-glow" id="current-focus-stat">None Set</span></p>
                    </div>

                    <div class="sys-card p-6 rounded-xl col-span-1 lg:col-span-2">
                        <h3 class="text-2xl font-bold mb-4 flex items-center">
                            <i class="ph ph-warning-octagon text-2xl mr-2 text-red-500"></i> URGENT INTRUSIONS ($\mathbf{\le 24 \text{h}}$)
                        </h3>
                        <div id="urgent-tasks-list" class="space-y-3 max-h-96 overflow-y-auto">
                            <div class="text-center p-4 opacity-70">No immediate threats detected. Good status.</div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="quests" class="view-section hidden">
                <h2 class="text-4xl font-bold mb-8 text-sys-text filter-sys-glow-filter">MISSIONS_COMPLETION_HUB</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="sys-card p-6 rounded-xl col-span-1 lg:col-span-2">
                        <h3 class="text-2xl font-bold mb-4 flex items-center">
                            <i class="ph ph-scroll text-2xl mr-2 text-yellow-400"></i> ACTIVE MISSION LOG
                        </h3>
                        <div id="full-tasks-list" class="space-y-4 max-h-[70vh] overflow-y-auto">
                            <div class="text-center p-4 opacity-70">Loading mission data...</div>
                        </div>
                    </div>

                    <div class="sys-card p-6 rounded-xl col-span-1">
                        <h3 class="text-2xl font-bold mb-4 flex items-center">
                            <i class="ph ph-calendar text-2xl mr-2 text-sys-neon"></i> SYSTEM CALENDAR
                        </h3>
                        <div class="flex justify-between items-center mb-4">
                            <button onclick="changeCalendarMonth(-1)" class="p-1 rounded-full hover:bg-sys-blue"><i class="ph ph-caret-left text-xl"></i></button>
                            <span id="current-month-year" class="font-bold text-lg"></span>
                            <button onclick="changeCalendarMonth(1)" class="p-1 rounded-full hover:bg-sys-blue"><i class="ph ph-caret-right text-xl"></i></button>
                        </div>
                        <div id="calendar-days-of-week" class="calendar-grid text-sm font-semibold opacity-70 mb-2"></div>
                        <div id="calendar-grid" class="calendar-grid">
                            </div>
                        <div class="mt-6 text-sm space-y-1">
                            <p><span class="inline-block w-3 h-3 rounded-full bg-red-600 mr-2"></span> Leave/Vacation</p>
                            <p><span class="inline-block w-3 h-3 rounded-full bg-blue-500 mr-2"></span> Exam/Test</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="stats" class="view-section hidden">
                <h2 class="text-4xl font-bold mb-8 text-sys-text filter-sys-glow-filter">PROGRESSION_VIEW_V3.0</h2>
                
                <div id="stat-message" class="bg-blue-900/50 p-4 rounded-xl mb-6 text-center text-sm">
                    Select a Stat Card and click **[Set AI Focus]** to direct the System's quest generation.
                </div>

                <h3 class="text-3xl font-bold mb-4 text-sys-neon">MAIN STATS</h3>
                <div id="main-stats-grid" class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-10">
                    </div>

                <h3 class="text-3xl font-bold mb-4 text-sys-purple">COMPLEMENT STATS</h3>
                <div id="complement-stats-grid" class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-12">
                    </div>

                <div class="text-center">
                    <button id="set-focus-button" onclick="setAIFocus()" disabled class="sys-button px-10 py-4 text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="ph ph-target text-xl mr-2"></i> Set AI Focus
                    </button>
                </div>
            </section>

            <section id="cms" class="view-section hidden">
                <h2 class="text-4xl font-bold mb-8 text-sys-text filter-sys-glow-filter">SYSTEM_EDITOR_V4.0 (CMS)</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-8">
                        
                        <div class="sys-card p-6 rounded-xl">
                            <h3 class="text-2xl font-bold mb-4 border-b border-sys-card pb-2">MISSION CONTROL: USER TASK INJECTION</h3>
                            
                            <form id="mission-form" class="space-y-4 mb-8">
                                <p class="text-sm opacity-75 text-yellow-400">Only **User Tasks** can be manually injected here. AI Quests are generated automatically.</p>
                                <input type="text" id="mission-name" placeholder="Mission Name (e.g., Complete Report Draft)" required class="w-full p-3 rounded-lg bg-sys-blue/70 border border-sys-neon/30 focus:border-sys-neon outline-none">
                                <textarea id="mission-description" placeholder="Description (Optional)" class="w-full p-3 rounded-lg bg-sys-blue/70 border border-sys-neon/30 focus:border-sys-neon outline-none"></textarea>
                                <input type="datetime-local" id="mission-deadline" required class="w-full p-3 rounded-lg bg-sys-blue/70 border border-sys-neon/30 focus:border-sys-neon outline-none">
                                
                                <div id="mission-logic-input">
                                    <label for="importance-slider" class="block mb-2 font-semibold">Importance Scale (1-10): <span id="importance-value">5</span></label>
                                    <input type="range" id="importance-slider" min="1" max="10" value="5" oninput="document.getElementById('importance-value').innerText = this.value" class="w-full accent-sys-neon">
                                </div>

                                <button type="submit" class="sys-button w-full">
                                    <i class="ph ph-rocket text-xl mr-2"></i> Inject New Mission Parameters
                                </button>
                            </form>

                            <div class="mt-6 border-t border-sys-card pt-4">
                                <h4 class="font-bold mb-3">Active Missions (Click to Edit/Remove)</h4>
                                <div id="cms-task-list" class="space-y-3 max-h-48 overflow-y-auto">
                                    <div class="text-center p-2 opacity-70">No missions to display.</div>
                                </div>
                            </div>
                        </div>

                        <div class="sys-card p-6 rounded-xl">
                            <h3 class="text-2xl font-bold mb-4 border-b border-sys-card pb-2">CORE STAT & PROGRESSION EDITOR</h3>
                            
                            <form id="new-stat-form" class="flex space-x-2 mb-6">
                                <input type="text" id="new-stat-name" placeholder="New Stat Name (e.g., Charisma)" required class="flex-grow p-3 rounded-lg bg-sys-blue/70 border border-sys-neon/30 focus:border-sys-neon outline-none">
                                <select id="new-stat-type" class="p-3 rounded-lg bg-sys-blue/70 border border-sys-neon/30 outline-none">
                                    <option value="main">Main Stat</option>
                                    <option value="complement">Complement Stat</option>
                                </select>
                                <button type="submit" class="sys-button p-3 rounded-lg"><i class="ph ph-plus text-xl"></i></button>
                            </form>

                            <div id="cms-stat-list" class="space-y-3 max-h-48 overflow-y-auto">
                                <div class="text-center p-2 opacity-70">Stats list loading...</div>
                            </div>
                        </div>

                    </div>

                    <div class="lg:col-span-1 space-y-8">
                        
                        <div class="sys-card p-6 rounded-xl">
                            <h3 class="text-xl font-bold mb-4 border-b border-sys-card pb-2">MANAGE SYSTEM ANOMALIES</h3>
                            <form id="event-form" class="space-y-3">
                                <input type="date" id="event-date" required class="w-full p-3 rounded-lg bg-sys-blue/70 border border-sys-neon/30 outline-none">
                                <select id="event-type" class="w-full p-3 rounded-lg bg-sys-blue/70 border border-sys-neon/30 outline-none">
                                    <option value="leave">Leave/Vacation (AI Skip)</option>
                                    <option value="exam">Exam/Test (Focus Day)</option>
                                    <option value="general">General Event</option>
                                </select>
                                <button type="submit" class="sys-button w-full">Mark Date on Calendar</button>
                            </form>
                            <div class="mt-4">
                                <h4 class="font-bold mb-2">Active Events:</h4>
                                <ul id="active-events-list" class="text-sm space-y-1 max-h-24 overflow-y-auto"></ul>
                            </div>
                        </div>

                        <div class="sys-card p-6 rounded-xl">
                            <h3 class="text-xl font-bold mb-4 border-b border-sys-card pb-2">AESTHETIC & LOGIC OVERRIDES</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-semibold mb-1">Color Scheme:</label>
                                    <button onclick="toggleTheme(true)" class="p-2 mr-2 rounded-lg bg-sys-neon/20 hover:bg-sys-neon/40 transition">Dark (Sung Jin Woo)</button>
                                    <button onclick="toggleTheme(false)" class="p-2 rounded-lg bg-sys-text/20 hover:bg-sys-text/40 transition text-sys-black">Light (Google)</button>
                                </div>

                                <div>
                                    <label for="reduction-slider" class="block font-semibold mb-1">Stat Reduction % on Level Up: <span id="reduction-value">75</span>%</label>
                                    <input type="range" id="reduction-slider" min="10" max="95" value="75" oninput="document.getElementById('reduction-value').innerText = this.value" class="w-full accent-sys-neon">
                                </div>

                                <div class="pt-4 border-t border-sys-card">
                                    <label class="block font-semibold mb-1">Watermark Identity Config:</label>
                                    <input type="text" id="watermark-name" placeholder="Name" class="w-full mb-2 p-2 rounded-lg bg-sys-blue/70 border border-sys-neon/30 outline-none">
                                    <input type="email" id="watermark-email" placeholder="Email" class="w-full p-2 rounded-lg bg-sys-blue/70 border border-sys-neon/30 outline-none">
                                    <button onclick="updateWatermark()" class="sys-button w-full mt-2 text-sm bg-gradient-to-r from-green-500 to-green-600">Save Identity/Watermark</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
        </main>

        <footer class="p-4 bg-sys-black border-t border-sys-card mt-auto text-center text-xs opacity-50">
            <p id="footer-watermark">
                SYSTEM MATRIX V4.0 // Designed by NEEL // Contact: neel@agency.com
            </p>
            <p class="mt-1">
                <span class="font-bold text-sys-neon">SEO Optimized:</span> Real-Life Gamification, Personal Progression, AI Task Manager, Dual-Theme CMS.
            </p>
        </footer>

    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-analytics.js";

        // Your web app's Firebase configuration (using your provided data)
        const firebaseConfig = {
            apiKey: "AIzaSyB8IKGuQhB5aCmaYNbyyGjGeU254h6EzSM",
            authDomain: "system-b4c3a.firebaseapp.com",
            projectId: "system-b4c3a",
            storageBucket: "system-b4c3a.firebasestorage.app",
            messagingSenderId: "213811302786",
            appId: "1:213811302786:web:9405d4bca16895cc3d7f9b",
            measurementId: "G-Y8RMV23ZT7"
        };
        
        // Log to confirm config is loaded before init
        console.log("Firebase config loaded successfully."); 

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const analytics = getAnalytics(app); // Keep analytics for completeness

        const provider = new GoogleAuthProvider();

        /**
         * The core function to initiate Google Sign-In and handle the result.
         * This function is attached to the Google button in the Start Screen.
         */
        window.signInWithGoogleFirebase = async () => {
            try {
                // Sign in with popup
                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                // Log details and pass to main app logic
                console.log("✅ Firebase Sign-In Success. User:", user.displayName, user.email);

                // Access the function from the main script block
                if (window.submitPlayerName) {
                    // Use the user's display name, email, and UID for the system
                    window.submitPlayerName(user.displayName || user.email.split('@')[0], user.email, user.uid);
                }

            } catch (error) {
                // Handle Errors here.
                const errorCode = error.code;
                const errorMessage = error.message;

                console.error("❌ Firebase Google Sign-In Error:", errorMessage, errorCode);
                if (window.alertUser) {
                    window.alertUser('AUTH FAILED', 'Sign-in cancelled or failed. Error: ' + errorCode + '. Check Firebase Console for enabled provider.', 'bg-red-700');
                }
            }
        };

        /**
         * Function to sign the user out of Firebase.
         * This function is attached to the new Sign Out buttons.
         */
        window.signOutUser = async () => {
            try {
                await signOut(auth);
                console.log("User signed out.");
                if (window.alertUser) {
                    window.alertUser('SYSTEM OFFLINE', 'You have been logged out. Re-activating system...', 'bg-red-500');
                }
                
                // Reset the application state and reload the start screen
                window.location.reload(); 

            } catch (error) {
                console.error("Sign out error:", error);
                if (window.alertUser) {
                    window.alertUser('ERROR', 'Sign-out failed: ' + error.message, 'bg-red-700');
                }
            }
        };

        // Attach event listener for the new Google Sign-In button
        document.addEventListener('DOMContentLoaded', () => {
            const googleSignInButton = document.getElementById('google-sign-in-button');
            if (googleSignInButton) {
                googleSignInButton.addEventListener('click', window.signInWithGoogleFirebase);
            }
        });
    </script>


    <script>
        // --- CORE DATA STRUCTURES & INITIALIZATION ---

        let gameState = {
            playerName: "NEEL",
            playerId: "SJW-001",
            level: 1,
            xp: 50,
            xpCap: 100,
            currentTitle: "Shadow Monarch",
            titleCollection: ["The Initiate"],
            aiFocusStat: null,
            statReductionPercent: 75, // from CMS slider
            theme: 'dark',
            watermarkName: "NEEL",
            watermarkEmail: "neel@agency.com",
            isInitialized: false, // NEW FLAG
            firebaseUID: null, // NEW: Store Firebase UID
        };

        let stats = [
            { id: 'strength', name: 'Strength', type: 'main', value: 100, icon: 'fist' },
            { id: 'intellect', name: 'Intellect', type: 'main', value: 85, icon: 'brain' },
            { id: 'vitality', name: 'Vitality', type: 'main', value: 90, icon: 'heart' },
            { id: 'agility', name: 'Agility', type: 'main', value: 70, icon: 'lightning' },
            { id: 'academics', name: 'Academics', type: 'complement', value: 65, icon: 'book' },
            { id: 'discipline', name: 'Discipline', type: 'complement', value: 80, icon: 'checks' },
        ];

        let missions = [
            { id: crypto.randomUUID(), type: 'task', name: 'Finish Q3 Financial Report', description: 'Priority for today.', deadline: new Date(Date.now() + 6 * 3600000).toISOString().slice(0, 16), importance: 9, statAffected: 'intellect' },
            { id: crypto.randomUUID(), type: 'quest', name: 'Daily 100 Pushups (AI)', description: 'System recommended physical training.', deadline: new Date(Date.now() + 48 * 3600000).toISOString().slice(0, 16), difficulty: 'medium', statAffected: 'strength' },
            { id: crypto.randomUUID(), type: 'task', name: 'Schedule Dentist Appointment', description: 'Low priority maintenance.', deadline: new Date(Date.now() + 168 * 3600000).toISOString().slice(0, 16), importance: 3, statAffected: 'vitality' },
        ];

        let events = [
            { date: new Date(Date.now() + 2 * 24 * 3600000).toISOString().split('T')[0], type: 'leave' }, // 2 days from now
            { date: new Date(Date.now() + 7 * 24 * 3600000).toISOString().split('T')[0], type: 'exam' } // 7 days from now
        ];
        
        // Calendar state
        let currentCalendarDate = new Date();

        // --- UTILITY & SPA NAVIGATION ---

        let currentView = 'index';
        const views = {
            'index': document.getElementById('index'),
            'quests': document.getElementById('quests'),
            'stats': document.getElementById('stats'),
            'cms': document.getElementById('cms'),
        };
        const body = document.body;
        const themeIcon = document.getElementById('theme-icon');
        const mobileMenu = document.getElementById('mobile-menu');
        const startScreen = document.getElementById('start-screen');
        const appContainer = document.getElementById('app-container');

        // Expose to window for the module script to call
        window.toggleMenu = function() {
            mobileMenu.classList.toggle('open');
        }

        window.navigateTo = function(viewName) {
            if (!gameState.isInitialized) return; // Prevent navigation before initialization

            currentView = viewName;
            
            // Hide all sections
            Object.values(views).forEach(v => v.classList.add('hidden'));

            // Show the selected section
            const targetView = views[viewName];
            if (targetView) {
                targetView.classList.remove('hidden');
                
                // Re-render data for the new view
                if (viewName === 'index') renderIndex();
                if (viewName === 'quests') { renderQuests(); renderCalendar(); }
                if (viewName === 'stats') renderStats();
                if (viewName === 'cms') renderCMS();
            }
        }

        window.toggleTheme = function(isDark) {
            if (typeof isDark === 'boolean') {
                gameState.theme = isDark ? 'dark' : 'light';
            } else {
                gameState.theme = gameState.theme === 'dark' ? 'light' : 'dark';
            }
            
            if (gameState.theme === 'dark') {
                body.classList.remove('light-mode');
                themeIcon.className = 'ph-fill ph-sun text-xl text-sys-text';
            } else {
                body.classList.add('light-mode');
                themeIcon.className = 'ph-fill ph-moon text-xl text-sys-text';
            }
        }

        window.updateWatermark = function() {
            gameState.watermarkName = document.getElementById('watermark-name').value || gameState.playerName || "System User";
            gameState.watermarkEmail = document.getElementById('watermark-email').value || "contact@system.com";
            document.getElementById('footer-watermark').innerHTML = `SYSTEM MATRIX V4.0 // Designed by ${gameState.watermarkName} // Contact: ${gameState.watermarkEmail}`;
            window.alertUser('Identity Saved', 'Watermark identity updated successfully.', 'bg-green-500');
        }
        
        // --- CORE GAME LOGIC / AI SIMULATION (logic.js) ---

        const DIFFICULTY_MULTIPLIERS = { easy: 2, medium: 4, hard: 6 };
        const STAT_ICONS = {
            strength: 'fist', intellect: 'brain', vitality: 'heartbeat', agility: 'shoe',
            academics: 'book-open', discipline: 'checks', creativity: 'lightbulb', finance: 'coin'
        };

        function calculateXP(mission) {
            let baseXP;
            if (mission.type === 'task') {
                // User Task Reward: 10 * Importance Factor
                baseXP = 10 * mission.importance;
            } else { // quest (AI)
                const multiplier = DIFFICULTY_MULTIPLIERS[mission.difficulty] || 1;
                // AI Quest Reward: (Level * Difficulty Multiplier) + Base Category XP
                baseXP = (gameState.level * multiplier * 10) + 50;
            }

            // AI Focus Boost (25% more XP for focused stat)
            if (mission.statAffected === gameState.aiFocusStat) {
                baseXP = Math.round(baseXP * 1.25);
            }
            return baseXP;
        }

        function calculatePenalty(mission) {
            const rewardXP = calculateXP(mission);
            if (mission.type === 'task') {
                // Task Penalty: 1.5x Reward XP
                return Math.round(rewardXP * 1.5); 
            } else { // quest
                // Quest Penalty: 1.0x Reward XP
                return rewardXP; 
            }
        }

        function processLevelUp() {
            // 1. Get Stat Reduction Percentage from CMS setting
            const reductionFactor = document.getElementById('reduction-slider').value / 100;
            gameState.statReductionPercent = parseInt(reductionFactor * 100);

            // 2. Stat Scaling: Reduce all stats
            stats.forEach(stat => {
                stat.value = Math.round(stat.value * (1 - reductionFactor));
                stat.value = Math.max(stat.value, 10); 
            });

            // 3. Update Level and XP Cap
            gameState.level += 1;
            gameState.xp = 0;
            gameState.xpCap = gameState.xpCap + (gameState.level * 100);

            // 4. Title Change (AI Criteria)
            const oldTitle = gameState.currentTitle;
            gameState.titleCollection.push(oldTitle);
            
            // Generate New Title (Simplified AI Logic)
            const highestStat = stats.reduce((prev, curr) => (prev.value > curr.value ? prev : curr), { value: 0 });
            let newTitle = `The ${highestStat.name} Ascendant`;
            if (gameState.aiFocusStat) {
                newTitle = `Focused ${gameState.aiFocusStat.charAt(0).toUpperCase() + gameState.aiFocusStat.slice(1)} Master`;
            } else if (gameState.level > 5) {
                newTitle = 'System Elite';
            }
            gameState.currentTitle = newTitle;

            window.alertUser('LEVEL UP!', `You are now Level ${gameState.level}! New Title: ${newTitle}. Stats were scaled down by ${gameState.statReductionPercent}%.`, 'bg-purple-600');
            console.log(`LEVEL UP! New Level: ${gameState.level}. Old Title: ${oldTitle} -> New Title: ${newTitle}. Stats reduced by ${gameState.statReductionPercent}%`);
        }

        function updateXP(amount) {
            gameState.xp += amount;
            if (gameState.xp >= gameState.xpCap) {
                processLevelUp();
            } else if (gameState.xp < 0) {
                gameState.xp = 0; // Prevent negative XP
            }
            renderIndex(); // Update dashboard XP bar
            renderStats(); // Update stats page (might trigger changes there)
        }

        function statChange(statId, amount) {
            const stat = stats.find(s => s.id === statId);
            if (stat) {
                stat.value = Math.min(Math.max(1, stat.value + amount), 999); // Max cap for visual effect
                console.log(`${stat.name} changed by ${amount}. New value: ${stat.value}`);
            }
        }

        window.completeMission = function(missionId) {
            const missionIndex = missions.findIndex(m => m.id === missionId);
            if (missionIndex === -1) return;

            const mission = missions[missionIndex];
            const xpReward = calculateXP(mission);
            const statAffected = mission.statAffected;

            // 1. Grant XP and Stat points
            updateXP(xpReward);
            statChange(statAffected, 15 + Math.round(xpReward / 10)); // Arbitrary stat gain based on XP

            // 2. Remove mission
            missions.splice(missionIndex, 1);

            window.alertUser('MISSION COMPLETE', `+${xpReward} XP awarded! ${mission.name} finished.`, 'bg-green-500');
            console.log(`MISSION COMPLETE: ${mission.name}. Gained ${xpReward} XP and boosted ${statAffected}.`);
            
            // 3. Re-render affected pages
            renderQuests();
            renderIndex();
            renderStats();
        }

        function failMission(missionId) {
            // This function is included for logic completeness but not directly called by UI buttons in Quests.html
            const missionIndex = missions.findIndex(m => m.id === missionId);
            if (missionIndex === -1) return;

            const mission = missions[missionIndex];
            const xpPenalty = calculatePenalty(mission);
            const statAffected = mission.statAffected;

            // 1. Apply Penalty
            updateXP(-xpPenalty);
            statChange(statAffected, -5); // Small stat loss

            // 2. Remove mission (failure means it's gone)
            missions.splice(missionIndex, 1);

            window.alertUser('MISSION FAILED', `-${xpPenalty} XP deducted! ${mission.name} failed.`, 'bg-red-500');
            console.warn(`MISSION FAILED: ${mission.name}. Lost ${xpPenalty} XP and ${statAffected} decreased.`);
            
            // 3. Re-render affected pages
            renderQuests();
            renderIndex();
            renderStats();
        }

        // --- RENDER FUNCTIONS FOR EACH VIEW ---

        // Renders the Index (Dashboard) View
        function renderIndex() {
            // Player Status Card
            document.getElementById('player-name').innerText = gameState.playerName.toUpperCase();
            // Use Firebase UID if available, otherwise fallback to default
            document.getElementById('player-id').innerText = gameState.firebaseUID ? gameState.firebaseUID.substring(0, 8) : gameState.playerId; 
            document.getElementById('player-title').innerText = gameState.currentTitle;
            document.getElementById('player-level').innerText = gameState.level;
            document.getElementById('player-xp').innerText = gameState.xp;
            document.getElementById('player-xp-cap').innerText = gameState.xpCap;
            document.getElementById('current-focus-stat').innerText = gameState.aiFocusStat ? gameState.aiFocusStat.toUpperCase() : 'NONE SET';

            const xpProgress = Math.min(100, (gameState.xp / gameState.xpCap) * 100);
            document.getElementById('xp-bar').style.width = `${xpProgress}%`;

            // Urgent Tasks Feed (<= 24 hours)
            const now = Date.now();
            const oneDay = 24 * 3600000;
            const urgentMissions = missions
                .filter(m => new Date(m.deadline).getTime() - now <= oneDay)
                .sort((a, b) => new Date(a.deadline) - new Date(b.deadline));

            const urgentList = document.getElementById('urgent-tasks-list');
            urgentList.innerHTML = '';

            if (urgentMissions.length === 0) {
                urgentList.innerHTML = '<div class="text-center p-4 opacity-70">No immediate threats detected. Good status.</div>';
            } else {
                urgentMissions.forEach(mission => {
                    const deadline = new Date(mission.deadline);
                    const timeRemaining = deadline.getTime() - now;
                    const hoursRemaining = Math.ceil(timeRemaining / 3600000);
                    const isTask = mission.type === 'task';
                    const typeColor = isTask ? 'text-red-400' : 'text-purple-400';
                    const icon = isTask ? 'ph-warning' : 'ph-scroll';

                    urgentList.innerHTML += `
                        <div class="sys-card p-3 rounded-lg flex justify-between items-center border-l-4 border-sys-neon/50">
                            <div>
                                <p class="font-bold flex items-center"><i class="ph ${icon} mr-1 ${typeColor}"></i> ${mission.name}</p>
                                <p class="text-xs opacity-70">Due: ${deadline.toLocaleString()} | ${hoursRemaining} hours left</p>
                            </div>
                            <span class="text-sm font-semibold ${typeColor}">${mission.type.toUpperCase()}</span>
                        </div>
                    `;
                });
            }
        }

        // Renders the Quests (Completion Hub) View
        function renderQuests() {
            const fullList = document.getElementById('full-tasks-list');
            fullList.innerHTML = '';

            if (missions.length === 0) {
                fullList.innerHTML = '<div class="text-center p-4 opacity-70">No active missions in the log. Inject new missions in System Editor.</div>';
                return;
            }

            // Sort by Deadline
            const sortedMissions = missions.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));

            sortedMissions.forEach(mission => {
                const deadline = new Date(mission.deadline);
                const isUrgent = deadline.getTime() - Date.now() <= 24 * 3600000;
                const isTask = mission.type === 'task';
                const typeColor = isTask ? 'text-red-400' : 'text-purple-400';
                const icon = isTask ? 'ph-warning-octagon-fill' : 'ph-scroll-fill';
                const urgencyBorder = isUrgent ? 'border-l-4 border-red-500' : 'border-l-4 border-sys-neon';

                fullList.innerHTML += `
                    <div class="sys-card p-4 rounded-xl flex justify-between items-center ${urgencyBorder}">
                        <div class="flex-grow">
                            <p class="font-bold text-lg flex items-center ${typeColor}">
                                <i class="ph ${icon} mr-2"></i> ${mission.name}
                                <span class="text-xs ml-3 font-medium py-1 px-2 rounded-full bg-sys-blue/50">${mission.statAffected.toUpperCase()}</span>
                            </p>
                            <p class="text-sm opacity-75">${mission.description || 'No description provided.'}</p>
                            <p class="text-xs opacity-50 mt-1">Due: ${deadline.toLocaleString()}</p>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button onclick="window.completeMission('${mission.id}')" class="sys-button px-3 py-1 text-sm bg-gradient-to-r from-green-500 to-emerald-600 hover:scale-105 transition">
                                <i class="ph ph-check-circle-fill"></i> Done
                            </button>
                        </div>
                    </div>
                `;
            });
        }
        
        // Renders the Stats (Progression) View
        let selectedStatId = null;

        function renderStats() {
            const mainGrid = document.getElementById('main-stats-grid');
            const compGrid = document.getElementById('complement-stats-grid');
            mainGrid.innerHTML = '';
            compGrid.innerHTML = '';
            
            // Update AI Focus Stat Display
            document.getElementById('current-focus-stat').innerText = gameState.aiFocusStat ? gameState.aiFocusStat.toUpperCase() : 'NONE SET';

            stats.forEach(stat => {
                const isFocused = stat.id === gameState.aiFocusStat;
                const isSelected = stat.id === selectedStatId;
                const cardClasses = `stat-card sys-card p-4 rounded-xl text-center cursor-pointer flex flex-col justify-between h-36 ${isSelected ? 'focused' : ''} ${isFocused && !isSelected ? 'border-2 border-sys-purple' : ''}`;
                const statIcon = STAT_ICONS[stat.id] || 'infinity';

                const statCard = document.createElement('div');
                statCard.className = cardClasses;
                statCard.setAttribute('onclick', `window.selectStat('${stat.id}')`);
                
                // Add simple gradient visual
                const gradientStyle = `height: 4px; background: linear-gradient(90deg, var(--sys-purple), var(--sys-neon)); width: ${Math.min(100, stat.value / 10)}%;`; // Value scaled down for visual

                statCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-sm uppercase opacity-80">${stat.type}</p>
                        <i class="ph ph-${statIcon} text-2xl text-sys-neon"></i>
                    </div>
                    <h4 class="text-3xl font-extrabold mb-1">${stat.value}</h4>
                    <p class="text-lg font-semibold">${stat.name.toUpperCase()}</p>
                    <div class="w-full bg-sys-blue/50 rounded-full mt-2">
                        <div style="${gradientStyle}" class="rounded-full"></div>
                    </div>
                    ${isFocused ? `<span class="text-xs mt-1 text-sys-focus-glow font-bold">AI FOCUS</span>` : ''}
                `;

                if (stat.type === 'main') {
                    mainGrid.appendChild(statCard);
                } else {
                    compGrid.appendChild(statCard);
                }
            });

            // Enable/Disable the Set AI Focus button
            document.getElementById('set-focus-button').disabled = selectedStatId === null;
        }

        window.selectStat = function(statId) {
            selectedStatId = statId;
            renderStats(); // Re-render to apply the 'focused' class
        }

        window.setAIFocus = function() {
            if (selectedStatId) {
                gameState.aiFocusStat = selectedStatId;
                selectedStatId = null; // Clear selection after setting focus
                window.alertUser('AI Focus Set', `System AI will now prioritize ${gameState.aiFocusStat.toUpperCase()} quests.`, 'bg-blue-500');
                renderStats(); // Re-render to update focus display
                console.log(`AI Focus set to: ${gameState.aiFocusStat}`);
            }
        }

        // Renders the CMS (System Editor) View
        function renderCMS() {
            // Update Watermark Config
            document.getElementById('watermark-name').value = gameState.watermarkName;
            document.getElementById('watermark-email').value = gameState.watermarkEmail;
            
            // Update Stat Reduction Slider
            const slider = document.getElementById('reduction-slider');
            slider.value = gameState.statReductionPercent;
            document.getElementById('reduction-value').innerText = gameState.statReductionPercent;

            // Render CMS Task List (CRUD)
            const cmsTaskList = document.getElementById('cms-task-list');
            cmsTaskList.innerHTML = '';
            const managedMissions = missions.filter(m => m.type === 'task'); // Only manage tasks
            if (managedMissions.length === 0) {
                cmsTaskList.innerHTML = '<div class="text-center p-2 opacity-70">No user tasks to manage.</div>';
            } else {
                managedMissions.forEach(mission => {
                    cmsTaskList.innerHTML += `
                        <div class="flex justify-between items-center sys-card p-3 rounded-lg">
                            <span class="text-sm font-semibold">${mission.name}</span>
                            <div class="flex space-x-2">
                                <button onclick="window.editMission('${mission.id}')" class="text-blue-400 hover:text-blue-200"><i class="ph ph-pencil-simple text-lg"></i></button>
                                <button onclick="window.removeMission('${mission.id}')" class="text-red-400 hover:text-red-200"><i class="ph ph-x-circle-fill text-lg"></i></button>
                            </div>
                        </div>
                    `;
                });
            }

            // Render CMS Stat List (CRUD)
            const cmsStatList = document.getElementById('cms-stat-list');
            cmsStatList.innerHTML = '';
            if (stats.length === 0) {
                cmsStatList.innerHTML = '<div class="text-center p-2 opacity-70">No stats defined.</div>';
            } else {
                stats.forEach(stat => {
                    cmsStatList.innerHTML += `
                        <div id="stat-row-${stat.id}" class="flex justify-between items-center sys-card p-3 rounded-lg">
                            <span class="font-semibold">${stat.name}</span>
                            <div class="flex items-center space-x-2">
                                <select onchange="window.updateStatType('${stat.id}', this.value)" class="p-1 rounded-md bg-sys-blue/70 text-sm">
                                    <option value="main" ${stat.type === 'main' ? 'selected' : ''}>Main</option>
                                    <option value="complement" ${stat.type === 'complement' ? 'selected' : ''}>Complement</option>
                                </select>
                                <button onclick="window.promptEditStatName('${stat.id}')" class="text-yellow-400 hover:text-yellow-200"><i class="ph ph-pencil-simple text-lg"></i></button>
                                <button onclick="window.removeStat('${stat.id}')" class="text-red-400 hover:text-red-200"><i class="ph ph-trash-fill text-lg"></i></button>
                            </div>
                        </div>
                    `;
                });
            }

            // Render Active Events List
            const activeEventsList = document.getElementById('active-events-list');
            activeEventsList.innerHTML = '';
            events.forEach((event, index) => {
                activeEventsList.innerHTML += `
                    <li class="flex justify-between items-center">
                        <span class="font-mono">${event.date}</span>
                        <span class="text-xs uppercase px-2 py-1 rounded-full bg-sys-blue/50">${event.type}</span>
                        <button onclick="window.removeEvent(${index})" class="text-red-400"><i class="ph ph-x text-sm"></i></button>
                    </li>
                `;
            });
        }
        
        // CMS Form Handlers
        document.getElementById('mission-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Type is now always 'task'
            const type = 'task';
            const name = document.getElementById('mission-name').value;
            const description = document.getElementById('mission-description').value;
            const deadline = document.getElementById('mission-deadline').value;
            const importance = parseInt(document.getElementById('importance-slider').value);
            
            // Simple Stat Assignment (random)
            const statOptions = stats.map(s => s.id);
            const statAffected = statOptions[Math.floor(Math.random() * statOptions.length)];

            const newMission = {
                id: crypto.randomUUID(),
                type,
                name,
                description,
                deadline,
                statAffected,
                importance // Only importance is used for tasks
            };

            missions.push(newMission);
            window.alertUser('Mission Injected!', `${name} added successfully.`);
            this.reset();
            renderCMS();
            renderQuests();
            renderIndex();
        });

        window.removeMission = function(id) {
            missions = missions.filter(m => m.id !== id);
            renderCMS();
            renderQuests();
            renderIndex();
        }
        
        window.editMission = function(id) {
            window.alertUser('Feature Disabled', 'Editing missions is currently blocked by Admin. Please remove and re-inject.');
        }

        // CMS Stat Handlers
        document.getElementById('new-stat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('new-stat-name').value.trim();
            const type = document.getElementById('new-stat-type').value;

            if (!name) return;

            const newStat = {
                id: name.toLowerCase().replace(/\s/g, ''),
                name: name,
                type: type,
                value: 50,
                icon: STAT_ICONS[name.toLowerCase().replace(/\s/g, '')] || 'infinity'
            };

            stats.push(newStat);
            this.reset();
            window.alertUser('New Stat Added', `${name} (${type.toUpperCase()}) added to Progression. Value set to 50.`, 'bg-green-500');
            renderCMS();
            renderStats();
        });

        window.updateStatType = function(id, newType) {
            const stat = stats.find(s => s.id === id);
            if (stat) {
                stat.type = newType;
                window.alertUser('Stat Type Updated', `${stat.name} is now a ${newType.toUpperCase()} Stat.`);
                renderStats();
            }
        }

        window.promptEditStatName = function(id) {
            const stat = stats.find(s => s.id === id);
            if (!stat) return;
            window.alertUser('Feature Disabled', 'Editing stat names is currently blocked by Admin.');
        }
        
        window.removeStat = function(id) {
            stats = stats.filter(s => s.id !== id);
            if (gameState.aiFocusStat === id) {
                gameState.aiFocusStat = null;
            }
            window.alertUser('Stat Removed', `Stat ID ${id} has been permanently removed from the system.`, 'bg-red-500');
            renderCMS();
            renderStats();
        }

        // CMS Event Handlers
        document.getElementById('event-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const date = document.getElementById('event-date').value;
            const type = document.getElementById('event-type').value;
            
            if (!date) return;

            // Check if date already exists
            if (!events.find(e => e.date === date)) {
                events.push({ date, type });
                window.alertUser('Event Scheduled', `${type.toUpperCase()} scheduled for ${date}.`, 'bg-blue-500');
            } else {
                window.alertUser('Event Exists', 'This date already has a scheduled event.', 'bg-yellow-500');
            }
            
            this.reset();
            renderCMS();
            renderCalendar();
        });

        window.removeEvent = function(index) {
            const event = events[index];
            events.splice(index, 1);
            window.alertUser('Event Removed', `${event.type.toUpperCase()} on ${event.date} has been removed.`, 'bg-red-500');
            renderCMS();
            renderCalendar();
        }
        
        // --- CALENDAR RENDER LOGIC ---

        function renderCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearSpan = document.getElementById('current-month-year');
            const daysOfWeekDiv = document.getElementById('calendar-days-of-week');
            calendarGrid.innerHTML = '';

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startingDayOfWeek = firstDayOfMonth.getDay(); // 0 for Sunday

            monthYearSpan.innerText = currentCalendarDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });

            // Render Days of Week (start with Sunday)
            if (daysOfWeekDiv.innerHTML === '') {
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayNames.forEach(day => {
                    daysOfWeekDiv.innerHTML += `<div class="text-center">${day}</div>`;
                });
            }

            // Fill leading empty days
            for (let i = 0; i < startingDayOfWeek; i++) {
                calendarGrid.innerHTML += '<div></div>';
            }

            // Render Days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = new Date(year, month, day).toISOString().split('T')[0];
                const event = events.find(e => e.date === dateString);
                let classes = 'day-cell';

                if (event) {
                    classes += event.type === 'leave' ? ' leave-day' : ' exam-day';
                }

                calendarGrid.innerHTML += `<div class="${classes}">${day}</div>`;
            }
        }

        window.changeCalendarMonth = function(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            renderCalendar();
        }

        // --- CUSTOM ALERT BOX (No native alert/confirm) ---

        window.alertUser = function(title, message, bgColor='bg-sys-neon') {
            const alertId = 'custom-alert-' + Date.now();
            const alertDiv = document.createElement('div');
            alertDiv.id = alertId;
            alertDiv.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-xl text-white z-[70] transition-all duration-300 transform translate-y-full opacity-0 ${bgColor}`;
            alertDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <h5 class="font-bold text-lg mr-4">${title}</h5>
                    <button onclick="document.getElementById('${alertId}').remove()" class="text-white opacity-70 hover:opacity-100"><i class="ph ph-x-circle-fill"></i></button>
                </div>
                <p class="text-sm mt-1">${message}</p>
            `;
            document.body.appendChild(alertDiv);
            
            // Animate in
            setTimeout(() => {
                alertDiv.style.transform = 'translateY(0)';
                alertDiv.style.opacity = '1';
            }, 50);

            // Animate out and remove after 4 seconds
            setTimeout(() => {
                alertDiv.style.transform = 'translateY(100%)';
                alertDiv.style.opacity = '0';
                setTimeout(() => alertDiv.remove(), 300);
            }, 4000);
        }
        
        // --- START SCREEN LOGIC ---
        // Expose submitPlayerName for the Firebase module to call
        window.submitPlayerName = function(name, email = null, uid = null) {
            gameState.playerName = name.toUpperCase();
            gameState.watermarkName = name.toUpperCase();
            if (email) gameState.watermarkEmail = email;
            if (uid) gameState.firebaseUID = uid;
            
            gameState.isInitialized = true;
            
            // Initialize main app content
            appContainer.classList.remove('opacity-0');
            
            // Animate the start screen out
            startScreen.style.opacity = '0';
            startScreen.style.pointerEvents = 'none';
            
            setTimeout(() => {
                startScreen.remove(); // Remove overlay after animation
                initializeUI(); // <--- RENAMED UI INIT FUNCTION
                window.alertUser('SYSTEM ACTIVATED', `Welcome, ${name.toUpperCase()}. Preparing your personalized progression matrix.`, 'bg-sys-neon');
            }, 500);
        }
        
        // Original form submission (Manual)
        document.getElementById('name-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const nameInput = document.getElementById('player-name-input').value.trim();
            if (nameInput) {
                // Call the unified function for manual input
                window.submitPlayerName(nameInput); 
            }
        });


        // --- INITIALIZATION ---
        // RENAMED FUNCTION TO AVOID CONFLICT WITH FIREBASE SDK'S initializeApp
        function initializeUI() { 
             // Apply initial watermark
            window.updateWatermark();
            
            // Set initial theme
            window.toggleTheme(gameState.theme === 'dark'); 

            // Initialize all views (rendering their current state)
            renderIndex();
            renderQuests();
            renderStats();
            renderCMS();

            // Set the default view to the Dashboard
            window.navigateTo('index');

            // Event listener for hamburger menu
            document.getElementById('menu-button').addEventListener('click', window.toggleMenu);
            
            // Event listener for theme toggle button
            document.getElementById('theme-toggle').addEventListener('click', () => window.toggleTheme());

            // Listen for changes on the stat reduction slider
            document.getElementById('reduction-slider').addEventListener('input', function() {
                gameState.statReductionPercent = parseInt(this.value);
            });
            
            console.log("System Matrix Initialized. Ready for command.");
        }

        window.onload = () => {
            // Since we are showing the start screen by default, we just wait for the user action.
        };
    </script>
</body>
</html>